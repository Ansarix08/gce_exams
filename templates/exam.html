{% extends "base.html" %}

{% block title %}Take Exam{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Day {{ settings.active_day }} Exam</h2>
        <div id="exam-timer" class="text-end">
            <h4 class="mb-0 text-primary">Time Remaining</h4>
            <div id="timer-display" class="display-6 fw-bold">--:--:--</div>
        </div>
    </div>

    <!-- Questions Section -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Questions</h4>
        </div>
        <div class="card-body" style="background-color: #f8f9fa; border: 1px solid #ddd;">
            {% if questions %}
                <div class="row gy-4">
                    {% for question in questions %}
                        <div class="col-12">
                            <div class="p-4 border rounded shadow-sm bg-white">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <h5 class="mb-0">Question {{ loop.index }}</h5>
                                        <small class="text-muted">Course: {{ question.course.name }}</small>
                                    </div>
                                    {% if question.id in answered_question_ids %}
                                        <span class="badge bg-success px-3 py-2">Completed</span>
                                    {% else %}
                                        <span class="badge bg-warning px-3 py-2">Pending</span>
                                    {% endif %}
                                </div>
                                <p class="mb-4">{{ question.question_text }}</p>

                                {% if question.id not in answered_question_ids %}
                                    <form method="POST" action="{{ url_for('submit_answer') }}">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <input type="hidden" name="question_id" value="{{ question.id }}">

                                        <div class="mb-3">
                                            {% for option, text in [
                                                ('A', question.option_a),
                                                ('B', question.option_b),
                                                ('C', question.option_c),
                                                ('D', question.option_d)
                                            ] %}
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="answer" id="option{{ loop.index }}_{{ question.id }}" value="{{ option }}" required>
                                                    <label class="form-check-label d-block px-3 py-2 rounded" for="option{{ loop.index }}_{{ question.id }}" style="border: 1px solid #ddd; transition: background-color 0.3s;">
                                                        {{ option }}) {{ text }}
                                                    </label>
                                                </div>
                                            {% endfor %}
                                        </div>

                                        <button type="submit" class="btn btn-primary">Submit Answer</button>
                                    </form>
                                {% else %}
                                    {% set user_answer = get_answer(current_user.id, question.id) %}
                                    {% if not exam_submitted %}
                                        <form method="POST" action="{{ url_for('edit_answer') }}" class="mt-3">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <input type="hidden" name="question_id" value="{{ question.id }}">

                                            <div class="mb-3">
                                                {% for option, text in [
                                                    ('A', question.option_a),
                                                    ('B', question.option_b),
                                                    ('C', question.option_c),
                                                    ('D', question.option_d)
                                                ] %}
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="answer" 
                                                               id="edit_option{{ loop.index }}_{{ question.id }}" 
                                                               value="{{ option }}"
                                                               {% if user_answer and user_answer.selected_answer == option %}checked{% endif %}
                                                               required>
                                                        <label class="form-check-label d-block px-3 py-2 rounded" for="edit_option{{ loop.index }}_{{ question.id }}" style="border: 1px solid #ddd; transition: background-color 0.3s;">
                                                            {{ option }}) {{ text }}
                                                        </label>
                                                    </div>
                                                {% endfor %}
                                            </div>

                                            <button type="submit" class="btn btn-warning">
                                                <i class="fas fa-edit"></i> Edit Answer
                                            </button>
                                        </form>
                                    {% else %}
                                        <div class="mt-3">
                                            <div class="mb-3">
                                                {% for option, text in [
                                                    ('A', question.option_a),
                                                    ('B', question.option_b),
                                                    ('C', question.option_c),
                                                    ('D', question.option_d)
                                                ] %}
                                                    <div class="form-check">
                                                        <div class="d-block px-3 py-2 rounded {% if user_answer and user_answer.selected_answer == option %}bg-light border{% endif %}" style="border: 1px solid #ddd;">
                                                            {{ option }}) {{ text }}
                                                            {% if user_answer and user_answer.selected_answer == option %}
                                                                <span class="badge bg-primary float-end">Your Answer</span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-info text-center">
                    <h4>No Questions Available</h4>
                    <p>Please contact your teacher to add questions.</p>
                </div>
            {% endif %}

            {% if questions and questions|length == answered_question_ids|length %}
                <div class="text-center mt-4">
                    <form method="POST" action="{{ url_for('submit_exam') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-lg btn-success">
                            <i class="fas fa-paper-plane"></i> Submit Exam
                        </button>
                    </form>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .form-check-label:hover {
        background-color: #f1f1f1;
        cursor: pointer;
    }

    .form-check-input:checked + .form-check-label {
        background-color: #d1e7dd; /* Light green */
        border-color: #0f5132;
        color: #0f5132;
    }

    .option-selected {
        background-color: #d1e7dd;
        border-color: #0f5132;
        color: #0f5132;
    }
</style>

<script>
    // Timer functionality
    let courseTimers = {{ course_timers|tojson }};
    let startTime = new Date();
    let maxDuration = 0;

    for (let courseId in courseTimers) {
        if (courseTimers[courseId] && courseTimers[courseId].duration_minutes > maxDuration) {
            maxDuration = courseTimers[courseId].duration_minutes;
        }
    }

    if (maxDuration === 0) {
        maxDuration = 180;
    }

    function updateTimer() {
        const now = new Date();
        const elapsedMinutes = (now - startTime) / 1000 / 60;
        const remainingMinutes = maxDuration - elapsedMinutes;

        if (remainingMinutes <= 0) {
            document.getElementById('timer-display').innerHTML = "00:00:00";
            document.getElementById('timer-display').classList.add('text-danger');
            const submitForm = document.querySelector('form[action="{{ url_for('submit_exam') }}"]');
            if (submitForm) {
                submitForm.submit();
            } else {
                alert("Time's up! Please submit your exam.");
            }
            return;
        }

        const hours = Math.floor(remainingMinutes / 60);
        const minutes = Math.floor(remainingMinutes % 60);
        const seconds = Math.floor((remainingMinutes * 60) % 60);

        const display = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        document.getElementById('timer-display').innerHTML = display;

        if (remainingMinutes <= 5) {
            document.getElementById('timer-display').classList.add('text-danger');
            document.getElementById('timer-display').classList.add('blink');
        } else if (remainingMinutes <= 15) {
            document.getElementById('timer-display').classList.add('text-warning');
        }
    }

    setInterval(updateTimer, 1000);

    // Option selection highlighting
    document.addEventListener("DOMContentLoaded", function () {
        const options = document.querySelectorAll(".form-check-input");

        options.forEach(option => {
            option.addEventListener("change", function () {
                const parent = this.closest(".mb-3");
                parent.querySelectorAll(".form-check").forEach(el => {
                    el.classList.remove("option-selected");
                });

                this.closest(".form-check").classList.add("option-selected");
            });
        });
    });
</script>
{% endblock %}
